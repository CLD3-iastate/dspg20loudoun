---
title: "Food Accessibility Scores"
output:
  pdf_document: default
  html_document: default
---

The regional accessibility indicator is created by examining the main sources of food supply within a specified radius.  The three types of food sources analyzed are food retailers, farmer’s markets, and food pantries.

To calculate a regional accessibility indicator at a census tract level, a center location must be determined. To find the center for each census tract, the geometric center of weighted by population density is used.

Centers of Population for the 2010 Census. 
Retrieved from <https://www.census.gov/geographies/reference-files/2010/geo/2010-centers-population.html>


For each census tract, only food supply sources within a specified radius would contribute to each census tract indicator.


Regional Food Accessibility = $\frac{\sum_{}^{} \frac{1}{distance}}{population}$

The summation of the inverse distances between each food supply source to the tract center was used to weight the closer food sources higher than those further away.

Lastly, the summation for each census tract is weighted by its census tract population to account for differences in rural and urban areas.
The results are regional accessibility indicators for each type of food source on the census tract level.


These indicators can help determine areas that likely require support to services such as food pantries, food banks and could potentially benefit from a local food hub.



## Food Accessibility Maps

[FarmersMarketsPlot20miles.](/static/food_access/FarmersMarkets20miles.png)

This map shows the regional accessibility of farmer’s markets in the Northern Virginia area.  The darker colors depict lower accessibility to farmer’s markets that are within 20 miles of each Census tract center.

[FoodPantriesPlot20miles](/static/food_access/Pantries20miles.png)

This map shows the regional accessibility of food pantries in the Northern Virginia area.  The darker colors depict lower accessibility to food pantries that are within 20 miles of each Census tract center.


[Retailer20miles.png](/static/food_access/Retailer20miles.png)

This map shows the regional accessibility of food retailers in the Northern Virginia area.  The darker colors depict lower accessibility to food retailers that are within 20 miles of each Census tract center.


[TransportationNoCar](/static/food_access/transportation.png)

This map shows the percent of households without a car on the Census tract level.
<https://rpubs.com/wellay01/NoVa_NoCar>


[FoodPantryIsochrone](/static/food_access/blue.png)

This isochrone map shows the accessibility of food pantries within a 10-minute drive for the Northern Virginia area.  The darker the shading of each map represents an overlap between the coverage of multiple food pantries.
<https://rpubs.com/wellay01/NoVaPantries>


[FarmersMarkets](/static/food_access/red.png)

This isochrone map shows the accessibility of farmer’s markets within a 10-minute drive for the Northern Virginia area.  The darker the shading of each map represents an overlap between the coverage of multiple farmer’s markets.
<https://rpubs.com/wellay01/FarmersNoVa>


[FoodRetailerIsochrone](/static/food_access/green)

This isochrone map shows the accessibility of food retailers within a 10-minute drive for the Northern Virginia area.  The darker the shading of each map represents an overlap between the coverage of multiple food retailers.
<https://rpubs.com/wellay01/RetailersNoVa>


```{r Food Access Data, include = FALSE, echo = TRUE, eval = FALSE}

library(dplyr)
library(ggmap)
library(leaflet)
library(rgdal)
library(sf)
library(rgeos)
library(stringr)
library(geosphere)
library(pracma)
library(tidycensus)
library(RColorBrewer)
library(png)
library(jpeg)

myACSkey <- ""
register_google(key = "")

farmersMarkets_data <-
  read.csv(
    "C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/FoodAccessGeoLocData/FarmersMarket_NOVA_geoloc.csv",
    header = T,
    stringsAsFactors = F
  )

foodPantry_data <-
  read.csv(
    "C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/FoodAccessGeoLocData/FoodPantry_NOVA_geoloc.csv",
    header = T,
    stringsAsFactors = F
  )

foodRetailer_data <-
  read.csv(
    "C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/FoodAccessGeoLocData/FoodRetailers_NOVA_geoloc.csv",
    header = T,
    stringsAsFactors = F
  )

CenterPop_tract <-
  read.csv(
    "C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/CenPop2010_Mean_TR51.txt",
    header = T
  )

map  <-
  st_read(
    "C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/VirginiaShapeFiles/tl_2019_51_tract.shp",
    stringsAsFactors = FALSE
  )

NOVA_TRnames <- read.csv("C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/NOVA_CensusTracts.csv",
                          header=T, stringsAsFactors = F)


# Get County Outlines
va_sf <- get_acs(
  geography = "county",
  state = "VA",
  county = c(
    "Arlington county",
    "Fairfax county",
    "Loudoun county",
    "Prince William county",
    "Alexandria city",
    "Falls Church city",
    "Fairfax city",
    "Manassas city",
    "Manassas Park city",
    "Fauquier County"
  ),
  variables = "B19058_002",
  survey = "acs5",
  key = myACSkey,
  year = 2018,
  output = "wide",
  show_call = T,
  geometry = T,
  keep_geo_vars = T
) %>%
  select(COUNTYFP, geometry)


# Get Loudoun County Outline only
loudoun_outline <- get_acs(
  geography = "county",
  state = "VA",
  county = c("Loudoun county"),
  variables = "B19058_002",
  survey = "acs5",
  key = myACSkey,
  year = 2018,
  output = "wide",
  show_call = T,
  geometry = T,
  keep_geo_vars = T
) %>%
  select(COUNTYFP, geometry)


# Rename columns in Census Tract Population Center data set
colnames(CenterPop_tract)[5] <- "CENTER.LATITUDE"
colnames(CenterPop_tract)[6] <- "CENTER.LONGITUDE"

for (i in 1:nrow(CenterPop_tract)) {
  CenterPop_tract$TRACTCE[i] <-
    str_pad(CenterPop_tract$TRACTCE[i], 6, pad = "0")
}

map$TRACTCE <- as.numeric(map$TRACTCE)
map$COUNTYFP <- as.numeric(map$COUNTYFP)
CenterPop_tract$TRACTCE <- as.numeric(CenterPop_tract$TRACTCE)
CenterPop_tract <- subset(CenterPop_tract, COUNTYFP != 113)

# VA only
CenterPopTR_map <-
  inner_join(CenterPop_tract, map, by = c("TRACTCE", "COUNTYFP"))
# anti_join(CenterPop_tract, map, by=c("TRACTCE", "COUNTYFP"))

CenterPopTR_mapNOVA <- CenterPopTR_map %>%
  filter(NAMELSAD %in% NOVA_TRnames$NAMELSAD)




```

```{r Calculate Inverse Distance, include = FALSE, message=FALSE, eval = FALSE}

# Helper function: calculates distance in meters given 2 sets of coordinates (long, lat)
# longitude first, then latitude
calculate_distance <- function(long1, lat1, long2, lat2) {
  ans <- distm(c(long1, lat1), c(long2, lat2), fun = distHaversine)
  return(ans)
}


# Pass in location points dataset
# radius defaults are 5, 10, 20 miles (in meters)
# uses Tract Population center
loc_within_radius <-
  function(loc_data,
           radius_1 = 8046.72,
           radius_2 = 16093.4,
           radius_3 = 32186.9) {
    centerData_copy <- CenterPopTR_mapNOVA
    
    centerData_copy$COUNT_5mile <- NA
    centerData_copy$INVERSE_DIST_5mile <- NA
    centerData_copy$COUNT_10mile <- NA
    centerData_copy$INVERSE_DIST_10mile <- NA
    centerData_copy$COUNT_20mile <- NA
    centerData_copy$INVERSE_DIST_20mile <- NA
    
    for (i in 1:nrow(centerData_copy)) {
      count_1 <- 0
      inverse_dist_1 <- 0
      count_2 <- 0
      inverse_dist_2 <- 0
      count_3 <- 0
      inverse_dist_3 <- 0
      centerData_copy$COUNT_5mile[i] <- 0
      centerData_copy$INVERSE_DIST_5mile[i] <- 0
      centerData_copy$COUNT_10mile[i] <- 0
      centerData_copy$INVERSE_DIST_10mile[i] <- 0
      centerData_copy$COUNT_20mile[i] <- 0
      centerData_copy$INVERSE_DIST_20mile[i] <- 0
      
      for (j in 1:nrow(loc_data)) {
        distance <-
          calculate_distance(
            centerData_copy$CENTER.LONGITUDE[i],
            centerData_copy$CENTER.LATITUDE[i],
            loc_data$lon[j],
            loc_data$lat[j]
          )
        
        if (distance <= radius_1) {
          count_1 <- count_1 + 1
          inverse_dist_1 <- (1 / distance) + inverse_dist_1
        }
        if (distance <= radius_2) {
          count_2 <- count_2 + 1
          inverse_dist_2 <- (1 / distance) + inverse_dist_2
        }
        if (distance <= radius_3) {
          count_3 <- count_3 + 1
          inverse_dist_3 <- (1 / distance) + inverse_dist_3
        }
        
      }
      if (centerData_copy$POPULATION[i] == 0) {
        centerData_copy$COUNT_5mile[i] <- count_1
        centerData_copy$INVERSE_DIST_5mile[i] <- NA
        centerData_copy$COUNT_10mile[i] <- count_2
        centerData_copy$INVERSE_DIST_10mile[i] <- NA
        centerData_copy$COUNT_20mile[i] <- count_3
        centerData_copy$INVERSE_DIST_20mile[i] <- NA
      }
      else{
        centerData_copy$COUNT_5mile[i] <- count_1
        centerData_copy$INVERSE_DIST_5mile[i] <-
          inverse_dist_1 / centerData_copy$POPULATION[i]
        centerData_copy$COUNT_10mile[i] <- count_2
        centerData_copy$INVERSE_DIST_10mile[i] <-
          inverse_dist_2 / centerData_copy$POPULATION[i]
        centerData_copy$COUNT_20mile[i] <- count_3
        centerData_copy$INVERSE_DIST_20mile[i] <-
          inverse_dist_3 / centerData_copy$POPULATION[i]
      }
    }
    return(centerData_copy)
  }

# Runtime varies by data size ~ 10 minutes
# Output columns are COUNT_5mile... COUNT_20mile, INVERSE_DIST_5mile...INVERSE_DIST_20mile
foodRetailer_invDist <- loc_within_radius(foodRetailer_data)
foodPantry_invDist <- loc_within_radius(foodPantry_data)
farmersMarkets_invDist <- loc_within_radius(farmersMarkets_data)


# Get google map background for Virginia
va_basemap <- get_map(location=c(lon = -77.5, lat = 38.8), zoom=9, scale = "auto", source = 'stamen')

```




```{r Food Retailer Plot 1, eval = FALSE, echo=FALSE, message=FALSE, fig.height = 6, fig.width = 7, fig.align = "center"}
mypalette1 <- colorQuantile(palette="OrRd", foodRetailer_invDist$INVERSE_DIST_20mile,n=8)


ggmap(va_basemap) +
  geom_sf(data=foodRetailer_invDist ,aes(fill= mypalette1(INVERSE_DIST_20mile), geometry=geometry), inherit.aes = FALSE) +
  geom_sf(data=va_sf, fill="transparent", color="black", size=.5, inherit.aes = FALSE) +
  geom_sf(data=loudoun_outline, fill="transparent", color="orange", size=.75, inherit.aes = FALSE) +
  scale_fill_brewer(name = "Relative Accessibility", palette = "OrRd", labels=c("High","","","","", "","","","Low")) +
  coord_sf(crs = st_crs(4326)) +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="right",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) +
   ggtitle("Food Retailer Access Index (20 Miles)")
  
  
```

  
```{r Food Pantry Plot 2, eval = FALSE,  echo=FALSE, message=FALSE, fig.height = 6, fig.width = 7, fig.align = "center"}
# Map of inverse distance of retailers within radius
mypalette2 <- colorQuantile(palette="OrRd", foodPantry_invDist$INVERSE_DIST_20mile,n=8)


ggmap(va_basemap) +
  geom_sf(data=foodPantry_invDist ,aes(fill= mypalette2(INVERSE_DIST_20mile), geometry=geometry), inherit.aes = FALSE) +
  geom_sf(data=va_sf, fill="transparent", color="black", size=.5, inherit.aes = FALSE) +
  geom_sf(data=loudoun_outline, fill="transparent", color="orange", size=.75, inherit.aes = FALSE) +
  scale_fill_brewer(name = "Relative Accessibility", palette = "OrRd", labels=c("High","","","","", "","","","Low")) +
  coord_sf(crs = st_crs(4326)) +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="right",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) +
   ggtitle("Food Pantry Access Index (20 Miles)")
```



```{r Food Market Plot 3, eval = FALSE,  echo=FALSE, message=FALSE, fig.height = 6, fig.width = 7, fig.align = "center"}
# Map of inverse distance of retailers within radius
mypalette3 <- colorQuantile(palette="OrRd", farmersMarkets_invDist$INVERSE_DIST_20mile,n=8)


ggmap(va_basemap) +
  geom_sf(data=farmersMarkets_invDist ,aes(fill= mypalette3(INVERSE_DIST_20mile), geometry=geometry), inherit.aes = FALSE) +
  geom_sf(data=va_sf, fill="transparent", color="black", size=.5, inherit.aes = FALSE) +
  geom_sf(data=loudoun_outline, fill="transparent", color="orange", size=.75, inherit.aes = FALSE) +
  scale_fill_brewer(name = "Relative Accessibility", palette = "OrRd", labels=c("High","","","","", "","","","Low")) +
  coord_sf(crs = st_crs(4326)) +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="right",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) +
    ggtitle("Farmer's Market Access Index (20 Miles)") 
```

```{r Composite Indicator Plot 4, eval = FALSE,  echo=FALSE, message=FALSE, fig.height = 6, fig.width = 7, fig.align = "center"}

composite_indicator_data <- read.csv("C:/Users/Admin/Documents/DSPG/Loudoun/GitHub/dspg2020Loudon/data/composite_indicator.csv",
                                     header =T)

# Drop first column (row numbers)
composite_indicator_data <- composite_indicator_data[,2:3]

composite_map_merge <- merge(map, composite_indicator_data, by="GEOID")

# Map of composite indicator
mypalette4 <- colorQuantile(palette="OrRd", composite_map_merge$comp_index,n=9)

ggmap(va_basemap) +
  geom_sf(data=composite_map_merge ,aes(fill= mypalette4(comp_index), geometry=geometry), inherit.aes = FALSE) +
  geom_sf(data=va_sf, fill="transparent", color="black", size=.5, inherit.aes = FALSE) +
  geom_sf(data=loudoun_outline, fill="transparent", color="orange", size=.75, inherit.aes = FALSE) +
  scale_fill_brewer(name = "Vulnerability", palette = "OrRd", labels=c("Low","","","","", "","","","High")) +
  coord_sf(crs = st_crs(4326)) +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="right",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) +
    ggtitle("Composite Food Insecurity Index") 
```


